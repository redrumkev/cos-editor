# COS Editor — macOS Release Guide

## Prerequisites

### 1. Apple Developer Credentials

You need three environment variables set before building a signed, notarized DMG:

| Variable | Description | Where to get it |
|----------|-------------|-----------------|
| `APPLE_ID` | Apple Developer account email | Your Apple ID email |
| `APPLE_APP_SPECIFIC_PASSWORD` | App-specific password | [appleid.apple.com](https://appleid.apple.com) > Sign-In and Security > App-Specific Passwords |
| `APPLE_TEAM_ID` | Developer Team ID | [developer.apple.com](https://developer.apple.com/account) > Membership Details |

Set them in your shell profile or export them before building:

```bash
export APPLE_ID="you@example.com"
export APPLE_APP_SPECIFIC_PASSWORD="xxxx-xxxx-xxxx-xxxx"
export APPLE_TEAM_ID="XXXXXXXXXX"
```

### 2. Code Signing Certificate

A valid "Developer ID Application" certificate must be installed in your macOS Keychain. electron-builder will discover it automatically.

## Building a Signed, Notarized DMG

```bash
cd ~/dev/cos-editor
pnpm install
pnpm run build:mac
```

This runs `electron-vite build` followed by `electron-builder --mac`, which will:

1. Compile the Electron app via Vite
2. Package the `.app` bundle with hardened runtime entitlements
3. Code-sign with your Developer ID certificate
4. Submit to Apple's notarization service and staple the ticket
5. Generate a DMG installer with the custom background

The output DMG will be in `dist/`.

## Publishing a Release

COS Editor uses GitHub Releases for distribution and auto-update.

### Option A: Tag-based release

```bash
# Bump version in package.json, then:
git add package.json
git commit -m "chore: bump version to X.Y.Z"
git tag vX.Y.Z
git push origin main --tags
```

Then build and upload the DMG to the GitHub Release created for that tag.

### Option B: Manual GitHub Release

1. Build the DMG locally with `pnpm run build:mac`
2. Go to [github.com/redrumkev/cos-editor/releases](https://github.com/redrumkev/cos-editor/releases)
3. Click "Draft a new release"
4. Create a tag (e.g., `v0.2.0`), add release notes
5. Upload the `.dmg` and the `latest-mac.yml` file from `dist/`
6. Publish the release

### Option C: CI/CD (recommended for automation)

Set `APPLE_ID`, `APPLE_APP_SPECIFIC_PASSWORD`, `APPLE_TEAM_ID`, and a `GH_TOKEN` as GitHub Actions secrets, then add a workflow that runs `pnpm run build:mac` on macOS runners and publishes via `electron-builder --publish always`.

## Auto-Update

The app checks GitHub Releases for new versions on startup (production builds only). When an update is found:

1. The update is downloaded automatically in the background
2. A notification informs the user that an update is ready
3. The update installs on the next app restart

The update channel is configured in `electron-builder.yml` under the `publish` section. The `latest-mac.yml` artifact (generated by electron-builder during `build:mac`) must be uploaded alongside the DMG for auto-update to work.

## Entitlements

The app ships with hardened runtime entitlements (`build/entitlements.mac.plist`):

- `com.apple.security.cs.allow-jit` — Required for V8/Electron JIT
- `com.apple.security.cs.allow-unsigned-executable-memory` — Required for Electron
- `com.apple.security.cs.allow-dyld-environment-variables` — Required for Electron

These are the minimum entitlements needed for an Electron app to pass notarization with hardened runtime enabled.
